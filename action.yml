name: Scripts Actions

inputs:
  github-ref:
    description: The GitHub branch reference
    required: true
  repository-name:
    description: The GitHub repository name
    required: true
  access-token:
    description: Cross repo access token
    required: true

runs:
  using: composite

  steps:
    - uses: everlytic/branch-merge@1.1.0
      with:
        github_token: ${{ inputs.access-token }}
        source_ref: 'main'
        target_branch: ${{ inputs.github-ref }}
        commit_message_template: '[RasentBot] Merged {source_ref} into {target_branch}'

    - name: Checkout scripts repo
      uses: actions/checkout@v2
      with:
        repository: california-energy-commission/scripts
        path: scripts
        token: ${{ inputs.access-token }}

    - name: Checking schema well-formedness
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/lint_schema.py schema
        fi
      shell: bash

    - name: Checking empty schema sections
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/empty_sections.py schema
        fi
      shell: bash

    - name: Checking responsible person sections
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/responsible_person.py schema
        fi
      shell: bash

    - name: Checking d:list inside d:list
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/d_list_markup.py schema
        fi
      shell: bash

    - name: Checking missing schema sections
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/missing_sections.py schema
        fi
      shell: bash

    - name: Checking for mismatched ComplianceDocument tags
      run: |
        if [[ ${{ inputs.repository-name }} != *"NonRes"* ]]; then
          python3 scripts/schema/compliance_document.py schema
        fi
      shell: bash

    - name: Checking for mismatched Header
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/header.py schema
        fi
      shell: bash

    - name: Checking for duplicate elements in each schema section
      run: |
        if [[ ${{ inputs.repository-name }} != *"NonRes"* ]]; then
          python3 scripts/schema/duplicate_elements.py schema
        fi
      shell: bash

    - name: Checking for incorrect end note naming in each schema section
      run: |
        if [[ ${{ inputs.repository-name }} != *"NonRes"* ]]; then
          python3 scripts/schema/end_notes.py schema
        fi
      shell: bash

    - name: Checking for empty displayterm tags
      run: |
        if [[ ${{ inputs.repository-name }} != *"NonRes"* ]]; then
          python3 scripts/schema/empty_displayterm.py schema
        fi
      shell: bash

    - name: Checking for missing base elements
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/missing_base_elements.py schema
        fi
      shell: bash

    - name: Checking for missing namespace declarations
      run: |
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          python3 scripts/schema/namespace_prefixes.py schema
        fi
      shell: bash

    - name: Checking for a mismatch between targetNamespace
      run: |
        if [[ ${{ inputs.repository-name }} != *"NonRes"* ]]; then
          python3 scripts/schema/document_mismatch.py schema
        fi
      shell: bash

    - name: Running deploy-schema script
      run: |
        chmod a+x scripts/deploy/deploy-schema-linux-amd64
        if [[ ${{ inputs.repository-name }} == *"Schema"* ]]; then
          ./scripts/deploy/deploy-schema-linux-amd64 -d deployed -s schema -v 2019.1.003
        fi
      shell: bash

    - name: Checkout current repository
      uses: actions/checkout@v2          

    - name: Checking stylesheet well-formedness
      run: |
        if [[ ${{ inputs.repository-name }} == *"Stylesheet"* ]]; then
          python3 scripts/stylesheet/lint_stylesheet.py stylesheet
        fi
      shell: bash

    - name: Run xslt transformation
      run: |
        if [[ ${{ inputs.repository-name }} == *"Stylesheet"* ]]; then
          python3 scripts/stylesheet/run_transformation.py stylesheet/CF2R/CF2RMCH01bE.xsl test/herinson/xml/CF2RMCH01bE1.xml
        fi
      shell: bash